<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PIR AM312 and ADC light sensor data</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="topbar">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/pir312/status">JSON</a>
    </div>

    <h1>PIR AM312 and ADC light sensor data</h1>

    <div class="row mono">
      sensors:
      <span id="sensors_raw">-</span>
    </div>

    <div class="row mono">
      light_raw:
      <span id="light_raw">-</span>
    </div>

    <div class="row mono">
      light:
      <span id="light">-</span>
    </div>

    <div class="row weak mono">
      Last update:
      <span id="ts">-</span>
    </div>

    <pre id="log"></pre>

    <script>
      'use strict';

      function byId(id) {
        return document.getElementById(id);
      }
      function logln(t) {
        const l = byId('log');
        l.textContent += t + '\n';
        l.scrollTop = l.scrollHeight;
      }

      async function fetchStatus() {
        const r = await fetch('/pir312/status', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      }

      function applyStatus(j) {
        const sensors = Array.isArray(j.sensors) ? j.sensors : [];
        byId('sensors_raw').textContent = '[' + sensors.join(',') + ']';
        byId('light_raw').textContent = j.light_raw != null ? String(j.light_raw) : '-';
        byId('light').textContent = j.light != null ? String(j.light) : '-';
        byId('ts').textContent = new Date().toLocaleTimeString();
      }

      async function refreshOnce() {
        try {
          const j = await fetchStatus();
          applyStatus(j);
        } catch (e) {
          logln('Error: ' + e);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        refreshOnce();
        setInterval(refreshOnce, 500);
      });
    </script>
  </body>
</html>
